# --- VariÃ¡veis ---
CLUSTER_NAME = terraform-cstrader
TF_VARS = -var-file cstrader.tfvars

# Ficheiros de output dos planos
PLAN_CLUSTER = cluster.plan
PLAN_APP = app.plan

.PHONY: init plan-cluster apply-cluster images plan-app apply-app start clean

# 1. Inicializar
init:
	terraform init

# --- FASE 1: O CLUSTER ---

# Cria o plano APENAS para o Minikube (ignora o resto por enquanto)
plan-cluster:
	@echo "ğŸ” Planning Minikube Cluster..."
	terraform plan -target=minikube_cluster.docker -out=$(PLAN_CLUSTER) $(TF_VARS)

# Aplica o plano do cluster
apply-cluster: plan-cluster
	@echo "ğŸš€ Creating Minikube Cluster..."
	terraform apply $(PLAN_CLUSTER)

# --- FASE 2: AS IMAGENS ---

# ConstrÃ³i e carrega as imagens (requer que o apply-cluster jÃ¡ tenha sido feito)
images:
	@echo "ğŸ› ï¸  Building images locally..."
	docker build -f ../backend/ops/Dockerfile -t cstrader:latest ..
	docker build -f ../frontend/Dockerfile -t cstrader-frontend:latest ../frontend/
	
	@echo "ğŸ“¦ Loading images into Minikube cluster: $(CLUSTER_NAME)..."
	minikube -p $(CLUSTER_NAME) image load cstrader:latest
	minikube -p $(CLUSTER_NAME) image load cstrader-frontend:latest

# --- FASE 3: A APLICAÃ‡ÃƒO (K8S) ---

# Agora que o cluster existe e tem imagens, planeamos o resto (Deployments, Services, etc)
plan-app:
	@echo "ğŸ” Planning Kubernetes App resources..."
	terraform plan -out=$(PLAN_APP) $(TF_VARS)

# Aplica o plano da aplicaÃ§Ã£o
apply-app: plan-app
	@echo "ğŸš€ Deploying App to Kubernetes..."
	terraform apply $(PLAN_APP)

# --- COMANDO MESTRE (JARVIS) ---
start_terraform: init apply-cluster images apply-app
	@echo "âœ… CSTrader deployed successfully via Terraform!"

# Limpeza
clean:
	terraform destroy -auto-approve $(TF_VARS)
	rm -f $(PLAN_CLUSTER) $(PLAN_APP)