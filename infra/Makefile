# --- VariÃ¡veis ---
CLUSTER_NAME = terraform-cstrader
TF_VARS = -var-file env.tfvars

# Ficheiros de output dos planos
PLAN_CLUSTER = cluster.plan
PLAN_APP = app.plan

.PHONY: init plan-cluster apply-cluster images plan-app apply-app start clean

init:
	terraform init

plan:
	@echo "ğŸ” Planning Kubernetes App resources..."
	terraform plan -out=$(PLAN_APP) $(TF_VARS)

# Aplica o plano da aplicaÃ§Ã£o
apply: plan
	@echo "ğŸš€ Deploying App to Kubernetes..."
	terraform apply $(PLAN_APP)



ingress-ip:
	@echo "ğŸ”§ Updating /etc/hosts..."
	@IP=$$(minikube ip -p $(CLUSTER_NAME)); \
	\
	# 1. Verifica se jÃ¡ existe (grep). Se NÃƒO existir (!), adiciona.
	if ! grep -q "cstrader.local" /etc/hosts; then \
		echo "Writing $$IP cstrader.local to /etc/hosts..."; \
		sudo sh -c "echo '$$IP cstrader.local' >> /etc/hosts"; \
		echo "âœ… Added!"; \
	else \
		echo "âš ï¸ Entry already exists. Skipping to avoid duplicates."; \
	fi

tunnel:
	@echo "ğŸš‡ Starting Minikube Tunnel (Sudo required)..."
	@echo "âš ï¸  KEEP THIS TERMINAL OPEN "
	minikube tunnel -p $(CLUSTER_NAME)


start_terraform: init apply ingress-ip tunnel
	@echo "âœ… CSTrader deployed! Run 'make ingress-ip' to see access info."


clean:
	minikube delete -p terraform-cstrader

	rm -rf .terraform
	rm -f *.tfstate
	rm -f *.tfstate.backup
	rm -f *.plan
	rm -f .terraform.lock.hcl

	terraform init